/*
 * Copyright 2024 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package io.github.hylexus.xtream.codec.ext.jt1078.codec.impl;

import io.github.hylexus.xtream.codec.common.utils.XtreamBytes;
import io.github.hylexus.xtream.codec.ext.MockNettyInbound;
import io.github.hylexus.xtream.codec.ext.jt1078.codec.Jt1078RequestCombiner;
import io.github.hylexus.xtream.codec.ext.jt1078.codec.Jt1078RequestDecoder;
import io.github.hylexus.xtream.codec.ext.jt1078.spec.Jt1078DataType;
import io.github.hylexus.xtream.codec.ext.jt1078.spec.Jt1078Request;
import io.github.hylexus.xtream.codec.ext.jt1078.spec.Jt1078RequestHeader;
import io.github.hylexus.xtream.codec.ext.jt1078.spec.Jt1078SubPackageIdentifier;
import io.github.hylexus.xtream.codec.ext.jt1078.spec.impl.DefaultJt1078PayloadType;
import io.github.hylexus.xtream.codec.server.reactive.spec.XtreamInbound;
import io.netty.buffer.ByteBuf;
import io.netty.buffer.ByteBufAllocator;
import io.netty.buffer.CompositeByteBuf;
import org.junit.jupiter.api.Test;

import java.time.Duration;
import java.util.ArrayList;
import java.util.List;
import java.util.stream.Stream;

import static org.junit.jupiter.api.Assertions.*;

class CaffeineJt1078RequestCombinerTest {
    static ByteBufAllocator allocator = ByteBufAllocator.DEFAULT;

    @Test
    void test() {
        final Jt1078RequestDecoder decoder = new DefaultJt1078RequestDecoder((nettyInbound, header) -> "traceId");
        final Jt1078RequestCombiner combiner = new CaffeineJt1078RequestCombiner(allocator, 100, Duration.ofSeconds(60));
        final List<ByteBuf> bufferList = mockByteBuf();
        try {
            final List<Jt1078Request> subRequests = new ArrayList<>();
            int mergedBodySize = 0;
            for (final ByteBuf byteBuf : bufferList) {
                final Jt1078Request subRequest = decoder.decode(true, "requestId", allocator, new MockNettyInbound(), XtreamInbound.Type.TCP, null, byteBuf);
                subRequests.add(subRequest);
                mergedBodySize += subRequest.body().readableBytes();
            }
            for (int i = 0; i < subRequests.size(); i++) {
                final Jt1078Request subRequest = subRequests.get(i);
                final Jt1078Request jt1078Request = combiner.tryMergeSubPackage(subRequest);
                if (i == subRequests.size() - 1) {
                    assertNotNull(jt1078Request);
                    doCompare(jt1078Request, mergedBodySize);
                    doEncodeAndCompare(jt1078Request, decoder, mergedBodySize);
                } else {
                    assertNull(jt1078Request);
                }
            }
        } finally {
            XtreamBytes.releaseBufList(bufferList);
        }
    }

    private static void doEncodeAndCompare(Jt1078Request jt1078Request, Jt1078RequestDecoder decoder, int mergedBodySize) {
        final CompositeByteBuf compositeBuffer = allocator.compositeBuffer();
        try {
            compositeBuffer.addComponent(true, jt1078Request.header().encode(true));
            compositeBuffer.addComponent(true, jt1078Request.body().retain());
            final Jt1078Request mergedRequest = decoder.decode(true, "requestId", allocator, new MockNettyInbound(), XtreamInbound.Type.TCP, null, compositeBuffer);
            assertEquals(mergedBodySize, mergedRequest.header().msgBodyLength());
        } finally {
            XtreamBytes.releaseBuf(compositeBuffer);
        }
    }

    static List<ByteBuf> mockByteBuf() {
        return Stream.of(
                        "81620000013800138999020100000092D6FA4C2E0000000003B600000001674D00149DB85825A100000300010000030008840000000168EE3C800000000106E501AB800000000165B800000303FABC11FF64C622EEDFEDD87FC1C413B3D5A4B602DF6282226EFE3CB96E93820D78E7193C68EBF22F7FB182B5F32A0E35D236EA45A8FB487769B0354AAC0498CCC58E2DD3AF04D28C354D608C9B0B794C10E13AA5C450731378135AAC4AC2780DE4BA66B6108F1EB68F5F256B461C3727C995C219B128B8F03C1EBCF9260FE614FE5910C753CD6B93BEA25AC1A849A3F3FED54897B7D9DA7C2BA45916379764211BEE142306893874834835334EE8CEF218450716764D5D43561DD3A71F2BC464F20B71EF1A679ED170422279CF68B192D7411725F3A256334CC03E52C0398DC1A5477C2359FCFAD05BEF252A8F2A64B47C00E4260FC7F53FB4DCE7975CC56CB742259897E1BBB294BC20530E6D83A77EFA229AEE56A7E55D537044A12A1747B7BAE6919175B0CFA3D4D2CEBAC33DA7B87F46A7B1FA693B99D9D6224457ACCDDC0560A6358C2B1214D7B24E67B289876655C98F4C79A5CBE948C563F8BA913BFF3FFEAD4CD04927709E82F836267C18346285EBA3731C75324E38C53BA3856CF08F3D2BF47B17E7D1D2C4762A45FC2DD09D1CAFB7E7C982C0CE8B08AB4339CC0F50CDD56B1B40E6E82401671925B383047358431D392CF666A3DA83887976DEF40CFB6F517AF9CBD7A9708D9D0156AA9C9D3ADED45B60F03D97C456FDCCF0C3A7C8C2443FCCCE0DCBF348EBEC0975482089FF4F5DC2DB25DC25C1325B45F179E02AE71249A377BD4662D2BAA93E8792E6391471E2AFCED5AE5C92681AF1015B98B6A93F03B0BB56D194E1684FCD29B4E691F0844D13B9787A62F3591CF819DA316C0C62607EFD2C108B91291C7B93E78B09FAB10C4D42D6C119614EE0D2B2F91FFB349522D30B336FE3C3EC683B1748541FC502905DC1C40822C76B618B6F6654909BFCC4D24B8652AEE4CEA8B2707400CED930ABA5E57483882CF16972404D3DAEE6A2FD7CD524A9B8012585600F661311AD77806EE56C882FFA3C1792C16F7775026067F394CC889A09CAD85F4C1A6FBAD42535CD30F8EE267638629043950A31623DD969C3FA9D6FB2138D37593CF68812167C82886815442D9FBADEAF0AC1CECFFFE7C87B95E663EDE4F4A56D6BE924FE8DC8119B3F2D5A16EF44BF07C934138E9CB4A7A07EE6C9F8DD6AAE40C6161C7762920167FE754063D6FC9A2ECF6D12FE3523D57A4EFA8FC9DDEB98206E23D43E2868ABE68C97B9D53B96D63C849DE85C7B8CFEF54D0FE7843564C24FE0E2874C899E8316DA92F8C56A3FFCB75C911FE31C",
                        "81620001013800138999020300000092D6FA4C2E0000000003B6B8ED8A6A9E4E99E466AF69E3793A52F99954392E2DBEEB3633CD9428FA2554BD2A051C73876627F59BC5D4E02120EB35C5C61CC2051CE8EDAB2C611FB3CE02FA5BFCB54B00F20F1D50EE6EF7900924A46363D38A6EFE0A5CB88EE419011359548C07977D06E9C63E50508CE6556BD201FA44698E2F6A438D56D49EAA2EF25E15703A32E414FA6E3803C074B21C056E43B1E24972758AD2AC7FD195F70E578DC9FC9E55DA4D9E6697506683A550B684E5DC086631FAE01B0221F2C60595CC55104E3217ADE63108B0EAA69CA812785275BE0FD3DB326C4F617015DA4CF057FEDED53ECA103FDA6CB495E9A26B3E035A5399B58442E0E05C98D79727FFC47A0091FC70B04E1F192913D2335537076F1A4A288FD52EFB3A1A421C0BD18BB3AD6DA018636DA261AFF4A4295B8029E6E0CD55AA69FB851CDD79B91CE1E854CEE729ACBE208D48350055DB3704DB45E2194FB54935468B2F788832AF41C18F52F3ADE0ED02C5D8821D981F21D3B8D01243A0083B92C205438500631A9BE01126380E9410585E6C7EDE1C9235DC254ACBC84E76E341DD63A79E9AA6ABE17FBF0EFDC27EA6C8E429B785A8632D6524739BC7EC0AE8F4A9F72DB60162A22201BB05598CAE90F7CA3D5248C11015160976CADEF9EE8F0DDAEE2D3AD334037EAEBD20A640FE5BD68EB408F6FFA472FF1BBF9DA3338F1B7A77ABC5F6E8863DF3BB17B70F8BFE69E801EC9EAE00BC0B5666F6B588E05A79A72743BC8BCFA50F0397FDCFD1EC28701C4AB644E1E880F8542A21ACBDA9462FE0EB29C0F93D04B045BDAB32CAC2CD8B2FBCFDC2C65B7862CA98416F19C477BEB1A960201AFFBC878843250A30C1B676E5C9222C7BCD8D35AAA38EFC10C21B3D728B61DB8FA96F51F8D2873D33ECEFAAE58C4F5D88D6005DCBF0DAE2ABD72B9BF611F5C6B04328BF1081D55C9744E45F33B82E60CAF2FCD828AE668012F3460152ED7184783E85B42C579E2BD008BEA66B6295E1BC07188D1020A280BBF4B769D278CD576B4AA4F9955F60B50C1AA68AB0EE7DD7043DCE507CBFC8114B3AFE53F2038F364CE0995FEF4DE36EC92DE679325719D1E9B269A0A63497D794E8F68DB35C74887C08EDF70D445ECDDDA64423BEE375A0DCC4037A2C883E877065F3B1136DCEB1B6191316C3B823AABACC87852B16265010D86FD8C0863EFFD678583F185A48FE05F5660B826C7E0ABB5C754160ED0B39DF3940AE0AD52776F12AE237B3B581EC17E5DF4E4EC4DF493764D648F1781E3A5691CC1F06D557798ABA3517DBA64A32D5110E16C1E37CA77C23FF1BF589B45FA0E5FFEA41E9B4FB210AB7B527B8C54CE1",
                        "81620002013800138999020300000092D6FA4C2E0000000003B66FA9F9DB107E39306B6EEC0872187A3DFEAB76817515C3CC29BF49D6CB71C625D7F01E56CCE8A4254A104A8E916118DB26157E44B0516ACBB38DAB59ACEF297E635DC3264C05A03FC187CBE78A89B4AC1E230120F1BEDC878425BE7E3E8FC6C1B5DA33A435CE88F3F8E129F595B3C717C02A9FED02697A228B029F6DDF2354B65837E4E54E684E7A03F3CBF4415A6146E82A8BB33155BCD7708EE596DA07592B68E4E0BED05D1672B4C573EF6C87999DFE219B797DCD909F61644674D4345795722D9E229ABE0EFF7841F117002499E3502A84D393D9356BEBC007AF64BAB910936D10FFF4C35D4D5405F3D3100EA9BF690AE7AB596AA852B625638FC07B44DBB8FFD23DF2E40A1AF94818332B7ADC54E698827D72DFE15EB6FC15DBCD189982A9B6E0177A5EF2348CA8F3AA76AEE35E5E218535929777EC739BB68B3A553AA47D382B914F4A2A973C65CBB6C473ABD38942E4C1EAD7258E82CD26A5F7432D8E361FC42C7F5EA141EE8018570ABCD975D26E79D3404B895D0CD02B8480290426CB5686C562D878A3566CD5DC5FED4264CE9E9DBD03BAC6D6A4186C6D87FA8DB738BD5D91B8BEAFFD1AEBFF937BA4B3CA233DE26CD4C42583A9E464DF5D690657DCD401A11BD78F432A71011F859C90D76EFCF23E06DA99DAD63E7FC0B196016E400E1BAAAC0EAFA0BB6196C0382783D475A4977CDE331C79C08E3B6D24F479B5D8D8DE2D49238D0C3F328085F62D061006F5E9A11A94F63F6DA7FBD0E8B2B8660BBA54151EBFFEA83B5BFB0CAB1705F22DECBF81EABCF1D90582C5D5F2026DD446E7AA63A2B61CA85CCF5B67C42E65FC55F31081D8DDD46273F33469EB84181ED1E4F12CFA590923C8217DB0B7F0A66B56B891D388A0F1B2D4481E36F6626D2EDA62574BF307480B93A87735AA812C6AA5423338CC3241AD21AF9F04ECFEAA8CC94F69D06179EC3705300883F57FF89DB134B042BBC2899EC3F2C89370812FB2764D5B9DD18DDBF561E563548AB6573C9B112556B3F568E9F2241CAF2FC3C545E4BEE993CC75B13330D8AFEF5875F7F592183871F86A4205E26A070AE8555AB30C7E16A8053DCB0526B74E24E4E948D4A2E706716D7C686D006201F953C7E8CCC70B9D407E6A15697F08DF1D428871C42AFAEDD88A44AE17A0401E90ECF45F0668C344CA064E26A06F1CEA3EBAB2D1D892EAA9A5C481551A6AC536895E08CC233CD6666D04E23B76BB4B05C881EAF6D6327FFECAC23441D9B9096CA2626F6B1B43ABC144EECDE5D897194A09D07E2587C91131C88BC2D81B05C6CED0E96A136B7C81EC4E46E8374FF32ADED87788B2BC886A28E43DEA",
                        "81620003013800138999020300000092D6FA4C2E0000000003B621A8278F811B15282F557216B3CBC11421C29C08D95CA6138F5F417DAA08BAAB781312A5B05D4F6F9134272A8E4FAF46EFD175D472306D2DB38990B513AFC447633209B1092406F2D2BA17BBDC40B5EAC38B71B85C6656E5966D53FF4C4C8FAED538BB36C08B47BFB8669C7038D03E540D8285DF06BB9A9C262254BC126405AC04E3EA81C45631F1D483B72CC3D90C5213DC80761B28FD99C1624D911B492084FC9F0ECBDE446385C7A1299DACEA330009C7B7CF7C7E8B9204C7CAF0442723E259255496EF7FD87E4C030535B3B0EE13648AC94419599958F5C5E599CA67566EC027D26AC15189A4160188067E1817A314F6DDE6E72D22641B2CB129A3181C99374AD87F57CED6AC54A015DE0D5C6004899BF90B7FF470AB6647C132773EFC6953242839A27603FB735A80083F66D7D4A59C3F6BF200EAE41E58C0F2251623097029C9D513270FD3DBE969134AFE64B52985297A6480C626EB9AD6DBB24B74C3314350334544817FCE5F35B239D0EC47FE9C90695389D060ED8217D67F25BF7972579DA02FC2CE334D2AF800E3750E17AC20516DB352D593192DE5A90783DAF26995DB1430F2C51B0B96FF64FBFB9688CF742509AF177489B27F434D37B0984DDF7A5E80F42E8FCE855F6B594AA83C5009B3D8EB27EACDE23CA87EEAC36E9E50DB89C870E666B815D55A96A7086D5CDE2967A5117E3F0F6440788DFA10326290064A20227F644BE4B2D85ED5F9D45C91721CBAFADADBB8458439E9FBC752262768F342F512C413DA4F62B6E76F9E18ABD846F2D510EA19BBDED47ABC23C6089877C17405FAE746513C7CF6BAA7665B6D67C745652E6AFFC3C13357E33A55605F23D3D5E444F4E8909AC9E1A70BE8A482021A123BAF26B499219BF3EAE300A79D3BF398DEA8934959BC8DAF562516139F3E86F29CB201CAF9E1938DD72DC632833BF35143532CD3B38B3B6784BF02473D4A2EE09CBD572D89E7E3150990AE3ED9184181AA5368C72642D74B34CA873C57D93D54010F0F449CB17651138EC1F68BFC793C12C71302D75E9B7BCF8D53220BE923709EE070A4F9DE98001FCE83F5712A11177D638A2A9E339923A9367E0287DFFA92238AFACE0AD80C2C3E2480E9A27D92C49CEC1B19E66659942439C0D2ECA1B030C2C11EA6B34D2F7483BFF8022C50171F20BC93CB1D51060321338444F2FA6EFB5900F1B81DA8BC5697E7ABAC4C3DED669B6B6FC738B9E67BF3A298069492A1CC259DA32F2AEF7F68C6400A822B87BF827C4339FBFEE2A9E70431CDC081AA598329A0607F19B62038998E2160101F4D60E2DAF506F41DA89211F29FE514A26CA63FB70E",
                        "81620004013800138999020300000092D6FA4C2E0000000003B639D8B2BD5BB7542FFA78BE9246D1E19ACFDFE725A5D15DA374574B03C022EEA0471A462310E5D916EBEEC3E7D9B695CEDA168CE7CFD58BA0E4D215138CFA118D16B11AD6FC0B476DF00BFA9A6CC62079ADBD3584298B15531E87E045899F3AF750B93CBC76EE616DFEF6CB3F83C7DE4DA5C678D4DCE4FF1A843290E4E4071EE3FE1CB2829AF2FD1A50C7D423452056D1BF1F9CC8F0998F5CF22578FD4B1348545E8C778CF38026A5C8DE91FA8A3DB83CADBA89ADFF5783BE057AD43142F66ADBE69DC8B64F1E0FE1D7C988F83D51302A9DBF12A8841A5C0A6CE71BBA0DDDC059C73ADF31016ED60D9EABAE4B9E9463D98C008E6C7F0288C9B123F7F501D891DA84127BD20F891A1F31E86C8EBD8A37D3CAE1C84139596CCD4EF4D226220C5EA5ED26E9B4A25DC88CCAE2A7370A51AD8D29D8D52E65A744E8959E0EA835F003A052DB15F4212BF8E0A805E11169B927E7AF39215A54D8C8FC92D9095A232CFD79B7642D2B5EADA9728F8908A6076C8C148AF69B2717B41B1CF9235927B7C05DCDEC862B6CE6C717CCDBF8E3DEAC1BC273E13EC0CAD7DA7C2EA02275441188B3252D74EA861B739DBFFCA71914C17E35F6E54155D4355AFB2336DD8BBE9C90CC493391819A3FA30C1DEBAF9ABACF44249C5842CFE37409248B164B37AD822972658ECB6B20CC9B18CF78D3673C972DF8C00CC95F0806C97109E4945DFF117216B71ACF45F8127B5FA79C8DCB557769F71492F631E73E61AA5E27E4FA442E9D88A1B85287A9AEA796CB1A3DD711B0F50257495A9EE8684256528538747FEB455C9107F76C4B9CE608163BFAB6EE2DC340ACF2BB3A45C83B38C5C43FF1A153C2EE281DA5F3F56794AC9B69F8E8E515F191060480D5C4CF18959C92CD7E7C75B6227CDAFDF2B590669DBB64EF6E665C6BF75A4CD116E1C45B87DE2FC5CE939817FB3F5F9EF97256EFEED5C03C6EAEE641B5BE5CC5C180907A45082FFCB1471AA3F12DD54FFDE84A22458FD8E70C2AF0DE0852871FA8CF2854852B90519E7E9AE86FDE3DF3257D737BC4867B98ABEE95204E27CB4891E9B8BCF84E6C74AEED966FAC25742DDAE8279C65B7C130C1C7BE367CAE3081802826E743A329E822D5853339ECEBC9787003D0AE309B8A286CA8D8403A55C15F37821C5AFAEB1EDEEFFBBFE4FB1099B9672192BC0BAD9F14FA5779034C4A131686F56045E08602B97D5B7BB59476847E4FF11002FC85B3E512C8CFD9F8591F84B3281EDD6171769331FE1EF7F21BA1FA548E323361C360FDDDB8CFB05B33D85D7AC46AD9A08F0558C2CE21C479AAD131E81E38166907C41401E04C36D8E201B8F84419",
                        "81620005013800138999020300000092D6FA4C2E0000000003B651D64DB3F2D9DDEBE1F9D8147D93E9CF7DC6DB5B6B88BAC867364D6B1ABCA624FF990BE529EF060B405C325E8516921C6F56FF3EDB31A3AA1863317D5C850F4BE2A3C587433BAB5846681169054E3BBE42B7A780B5A6E7FE196593449D7DBC95B2640E70A3D429DE2A1C798D0436F58A7A03DCA0A834CA33459FD2C4A824D833949BFABB130449168551EC48B1189801742CB3E2D825355018F984968284DADFBDC42977C305B8ECB4CDD200F95F983EFF31AB6AC656E1B394EF8CE272DB6057A2A0DCA4D7375BB9C04FD8C9CD2C758C0856C32E814674C78C5B630DF6196E3CEB964FA9F4B655187E6CFFDC55EA4F7EA1F7BCE0E85431F300BC8123B373A1DA577FABD84E72E2B144615676FB4B520419FAD35B22EF9F751D41D0E0F8353138BAF0C9F60B3BCDD54D4C236F2F84EA07C9ACE5B502C9316225F43F8A34B723A591E15A4E16A01C9478C05FE5F6144F4121B1E5BF6E8ED9E8ABE9CECBE3D72A9FA5ADC26135D9B98C368A101FE1CBF42CC64DF2940A65C96A96F25D3ACB77B9A90F74E1EEED5C1B0BCEDABD2BB8C3BA16774629D636F49496DD37189E86D993F81A9A0DBE301CB87203789B954E0AD803A5F1465C9E3E060A2C50B9C50650842F41B85D1BF59C7395931047D95F36DCC88D6812BD570A8AE08946999C7B812CA9CC0B1FEDD0368A014009417568A1DE5A6C9DF6C46784BA6553B88B0322361E6943AD97E4270BF775DD242AE8E93B64EC2E931FEB1688FB76368739CBB2150906DE3101055A02D1CE8F863BAE558B84F72BB98A06CC10186618E6F93563C9EDE59DB08ED4A5AC952F5FD9B84160D8292E4BF3751BEB0FD0F999A5EF40B91B2C8DB665889817DD7B7F27841335992440453484A6EA55C8D3D8CBAC00B7B9C9AB6E428F5B824B182EF07BAFDD131F24DCE431CB05EC8A1A8F0F9E270EBEF42B3ACDBCE4FEC5F9C86396086FABC08BC761661DB9C8C7E36B441E1144804061A28D61DC6B93D6FACDD6EBBC653799BF6AE8CA50BFD9110BF1BC45362AFB2BDEC5D6B22AEE53D1B2D48CE7473FC1B7A93473C820DA86FA0460F22ECE68FA67E2298BBD018913225BC177F45D18AB19D8C9A42C7B8AD59C3D6157359538D4EA3AD08972C1EAE0461E031F75DD4204CBF738DEF67031D8B2F4C4950ADEC3ACDF0D9AC175C10183E1FF20A138C5790E1936547B6CABE401740BB00651C77DC85A79F542EC0A2D75E37CF41FBE8B7A37AB32265AFCCA67E95490822871787CD7DFA0E99013C830501E4EAFDDE06A6B929A3F0804C1571536647E48D2C8AE662A4A3B2D493EE7E1A253AB5D5B3A9CB2F020304688D22E7CFB876CE0",
                        "81620006013800138999020300000092D6FA4C2E0000000003B629E547B22C0169B773A4881F0921F5FF8BCFCD13FE8A60AB6EB62A823DAA6F6B52633FDD740DCED9E792504742A0F302E1430F78272493ADEB4E981A0301710D5133F76A02B3D70374E3F233287C00CE947E0A7CD5C15A08DC1EB87A943DF77071C1E93D627CCFC756EF3C674B9A457782038B90FCE4AAD64A2F245DDF0D5D64DBA3388F0868B6AC2721C05731D79D6439FD7F88A3418CE83311E0E1E44E5CB27A49D6CB36E8AC6D5FABE596030DA019F534A848CB5051771C6DFB45C66BB609DD6ED55739FDF5EE7B20144708307E65791A360A062963FE315D36630AE1F580428C9BF45448AC9456F63FE4F41C235776BF50A95AA85F0A025B265550FB68E60FAAE5F927FBEB4D2585708E865F4D33D72A11045ABA32FE0E09E3553989C4A224BBF233BF5ABBA6A05ACB94C861F0903A432915D6AE35F6ACAC55706F1D8540A97F4962EBE4DAE0103489C0D32FC90D81619FB71426F11C0126504D07B43343CA0A1C4E13572EBF41EB4D10E26FF9D3EA76BC4553CBA09E3ED17750A495ECE52C2E6DBAAC7CAC86C3FBE143684FC82EBD799820D661D44E761A3EE1025A0389C16DB5F8E55F1C1CEE44D0B9EAF1852789CDC325CFFFDE4A19868A5209DD7E5CCB4FD2512BC8789C335AE65BC1834C6FE94CF01BC79B4A9C280C8AF4C89C712EE66E4E3050B2D778AF14CDB2B6FE055378577D3A3A5B05D342ED896DF59B546D0F6D2F008E4D0D494B1768AC5822A69C9BAE5C8CFD3460659797B5A98350E3639DAF79EE1F9A679E332FC80AB1C7EFDAC7C15647B8BAF426C0F481DBAC0703568955CC8EB2A64EFB70B0B618AA78CD95AD43D54E1F0BE00D6A3AA172F741238B2CF35C0A84C63EFED343B1495EE7B253F18A182D4E3688850841E571A63C31B9A74F0B299B217CD466094D7E20CD92265DADB0682B3E001B16AA6F86F69B3EBEC9E99C6F467A85B6AB7E324F489FF6AFD717E68C395E58C6839709555E0A94E5780153FE9425C99955DE512C6439721CE8507EB05A32262AFE9010142ECBB128963D440AC4807EBDE985CDF4B0A984201B821294E60502ED52270958242C6CC7B0042BE509E554F10E28A95F9942F32E353A8A4FD6D81C98711B991513941D89F26931AD705A9E23BF754D026B7DD1E92B67216EF0FAA4393E60E010F788DAB8FEAE6F206C933D5454112B52C17813BE486817F9F0C5F9A13BF5DDFF65F2F0E1480B3026274AA635FFF4B76C2F380AC561402770E8475E296EA6D0B4B17156FEBA6EAEE59115C26FE30DBF10255B796C3FBC7C24A6BBC5F64C0C17E981735C7275B2A4E24754AC7E418100C6F0A6FDB1A7C53E5859E0",
                        "81620007013800138999020300000092D6FA4C2E0000000003B6E827A13908ADD1B8C3C262FDC90C79568B4B75BBBF7E964779B128A6571369A21C116B7AF37B331A2CB3783894B5496C8EF5CC64DDAF883AAAC1BCF09CAE3DD551C93C0B9B3925EE4C9C95CAA45EB65337F2E74754DC356EBE5D02D4BE48F07A06F500189403AD903139DFC45964E3F9D2D5BD8CEB308E46D234956A3F786EAF2A5DAB2D6A7A864261CA1A61D992E58DF4DF3C63112BDAA48A1C97919FE3510D4E55FA6D2F1CD0EE1BC18C823AE7D8B20043C13CBD3B1EA7BA6362026F3E813A27F3522CC6D5A7C8EA0220877338DBD347FBFFD64D874EC1865F7D21EA47F096E1295BB63D73F911C076D18C50DA0E2BBB651C32A3ED931836E9E87B5B51A75EFF5322780DE00B4594C80D4703FFAF571270417782FE7EBA43288875E0A7C24884163FACFA760DDF5C8D0654A2693C18931C151EA14A4E5CA5F1E0F8663A64D01DF2404F62ED2104B7B46C1013C43170367668F55997D5DDB5C303B78461945F69724298DECA27CEEC8CB95D02ABC85F107808818E93A91371EA27F3FEE41C69826F307E4B5A3227D8C391D7A6D26BC5CF57D39A463E8896C58DD4DB0E1EC5B7D08472004BF90630A0F656D1A590E67EC5174E8063129ACF91B60A5DFACAE69859BEF34BE6C79D65D5A600FEBFF497846BD469FBBA57ECCC5E2DEE095D7D1C76177BEE35CFC0051AF581F296EA895016C0AFF67735C0EB624F60DECA810E94E84BD521726830F329CCAF45B40F995FB29E710E1C83B5E6375A0A508AF4A58C877164DB2ABF473889CE5E647E5691B8AE4DE90F894933343C6F008BB0E01E8494F14CC3A2A60807AA5FB74F9EAA46D29C3367825BE09C6AE66EF8F95E7B4C71906BFE41964FEB453781791CA1F0345F31701138F9A08C2546868D3AC1C6309A10518A1CD11459F541128FBD54519BA8D063AFE04B7499699B212810E2B581B8BEC6E7529CAD72F614918C83053FCFE69FA8DC8ED9ABA9F020288A9A470BFE1D538B8E55D8B1BA76A5C517C0F906493AF72E970CE7D6DC58D65133E35F2D54CEA5794C5D3991FF4DFFE6CB0D69C840A186DD0082FC3702CAF757C66C5053A7DA8A0C992D83EC8ABFAD6F6C0B2505295DD4E076450C07485A91C2D3D6BE5CA3947D8FB8D01F8472CE37A431257AB5D3B497ADA16DB466AB6A84DE75151FACCCA53225E59F9140FFBA56D8C4225382B2E0DCFD61B4CCB0E01AA70FC34205E76B7C2D9FF1E591768EE6AAEA1DF2FFEC76134A7153BC0F94E66C9F6E02716A6FF636CAC019383999A3FFA31A7A21EA6CAC384DDBDBD4B808315E9F025EF38C752995D83DB5634291B4D28E12568A152BF3016D5C9BFA5462E9",
                        "81E20008013800138999020200000092D6FA4C2E000000000150571FA8994811DD9F1D67F2BA46FBE55A1091FBF0AC34453CD7DFCB95D5D00DA71424544B4346A5C1446071A63C9FB792887F92C2E0C86F35BFB5DCA6225B781199A6A9C3AD8A9A4BBED88B26D4054B44B099ED49328B4A7AF67AE24DEFF0C3ADBA29329B1B41BA7757BFCB01439021B9394F9ED1CB13414DABD74202B8969A083915AE553BACE2103234870A1D2AAE25B5737B5E67744BD3E1C0B135F1D6BAB98DE4D7ECB5AF08E762DBB3FF19673B783B470F03B238E58480443D76AF0E4D4C80242812263CC9DEBD5AF0F5BF9D00D135FBE9206EC6A967DD28E05FF4B537094B78DD5054FF66836A231F28D2CA5F052397782B9DE5BD3FF4193CE9B1D9FD998EE15A71047E985A39FD157C5717EBBADEB9740810E1C9A77883F601FFFCA0FFCEC7F8C1F8488B0FB6D14A891482079EB0CB3F7579014FF646757A4CEB6CACC25744F7F171CACC7FE29A0AFE4C000000"
                )
                .map(it -> XtreamBytes.byteBufFromHexString(allocator, "30316364" + it))
                .toList();
    }

    private static void doCompare(Jt1078Request request, int mergedBodySize) {
        final Jt1078RequestHeader header = request.header();
        assertTrue(header.isCombined());
        assertEquals(2, header.v());
        assertEquals(0, header.p());
        assertEquals(0, header.x());
        assertEquals(1, header.cc());

        assertEquals(1, header.m());
        assertEquals(DefaultJt1078PayloadType.H264, header.payloadType());

        assertEquals(8, header.sequenceNumber());
        assertEquals("013800138999", header.sim());
        assertEquals(2, header.channelNumber());
        assertEquals(Jt1078DataType.VIDEO_I, header.dataType());
        assertEquals(Jt1078SubPackageIdentifier.ATOMIC, header.subPackageIdentifier());

        assertTrue(header.timestamp().isPresent());
        assertEquals(630671952942L, header.timestamp().get());

        assertTrue(header.lastIFrameInterval().isPresent());
        assertEquals(0, header.lastIFrameInterval().get());

        assertTrue(header.lastFrameInterval().isPresent());
        assertEquals(0, header.lastFrameInterval().get());

        assertEquals(mergedBodySize, header.msgBodyLength());
        assertEquals(7936, header.msgBodyLength());
    }
}
